<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Browser for OpenAI Operators</title>
    <script src="https://apis.google.com/js/platform.js?onload=initGoogleAPI" async defer></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.814.0.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 800px;
        margin: auto;
      }
      select, button {
        margin-right: 10px;
        margin-bottom: 10px;
      }
      img {
        max-width: 100%;
        margin-top: 10px;
      }
      #imagePreview {
        display: none;
        border: 2px solid #ddd;
        padding: 10px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Image Browser for OpenAI Operators</h1>
      <p>Please log in to view and browse images captured by remote devices.</p>
      <button id="google-login-btn">Sign in with Google</button>

      <h2>Image Selection</h2>
      <select id="deviceSelect">
        <option value="">Select Device</option>
      </select>
      <select id="yearSelect" disabled>
        <option value="">Select Year</option>
      </select>
      <select id="monthSelect" disabled>
        <option value="">Select Month</option>
      </select>
      <select id="daySelect" disabled>
        <option value="">Select Day</option>
      </select>
      <select id="hourSelect" disabled>
        <option value="">Select Hour</option>
      </select>
      <div id="imageLinks"></div>
      <div id="imagePreview">
        <h3>Image Preview</h3>
        <img id="previewImg" src="" alt="Image Preview">
      </div>
    </div>

    <script>
      const bucketName = "images-947384912039";
      const region = "us-east-1";
      const identityPoolId = "us-east-1:057eb5c9-a520-4373-80c6-7d43fe3673cb";
      let s3;

      // Initialize Google API on load
      function initGoogleAPI() {
        gapi.load('auth2', () => {
          gapi.auth2.init({
            client_id: "859878185380-o0g59tkq13jm1dhqbt4eb4a4bmgqgjsr.apps.googleusercontent.com"
          });
        });
      }

      // Google sign-in button handler
      document.getElementById('google-login-btn').addEventListener('click', () => {
        const auth2 = gapi.auth2.getAuthInstance();
        auth2.signIn().then(user => {
          const idToken = user.getAuthResponse().id_token;
          authenticateWithAWS(idToken);
        }).catch(err => {
          console.error("Google Sign-In Error", err);
          alert("Google Sign-In failed. Please try again.");
        });
      });

      function authenticateWithAWS(idToken) {
        AWS.config.region = region;
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: identityPoolId,
          Logins: {
            'accounts.google.com': idToken
          }
        });

        AWS.config.credentials.get((err) => {
          if (err) {
            console.error("AWS Credentials Error", err);
            alert("Error authenticating with AWS: " + err);
          } else {
            s3 = new AWS.S3({ apiVersion: '2006-03-01' });
            listDevices();
          }
        });
      }

      function listDevices() {
        const params = { Bucket: bucketName, Prefix: "" };
        s3.listObjectsV2(params, (err, data) => {
          if (err) {
            console.error("Error listing objects", err);
            return;
          }
          const uniqueDevices = new Set();
          data.Contents.forEach(item => {
            const parts = item.Key.split("/");
            if (parts.length > 0) uniqueDevices.add(parts[0]);
          });
          populateDropdown(document.getElementById('deviceSelect'), Array.from(uniqueDevices));
        });
      }

      function populateDropdown(dropdown, options) {
        dropdown.innerHTML = '<option value="">Select</option>';
        options.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.textContent = option;
          dropdown.appendChild(opt);
        });
        dropdown.disabled = false;
      }

      document.getElementById('deviceSelect').addEventListener('change', (e) => selectDatePart(e, 'year'));
      document.getElementById('yearSelect').addEventListener('change', (e) => selectDatePart(e, 'month'));
      document.getElementById('monthSelect').addEventListener('change', (e) => selectDatePart(e, 'day'));
      document.getElementById('daySelect').addEventListener('change', (e) => selectDatePart(e, 'hour'));
      document.getElementById('hourSelect').addEventListener('change', listImages);

      function selectDatePart(event, nextPart) {
        const value = event.target.value;
        if (!value) return;
        const selectedPart = event.target.id.replace('Select', '');
        const prefix = getCurrentPrefix(selectedPart);
        const params = { Bucket: bucketName, Prefix: prefix };

        s3.listObjectsV2(params, (err, data) => {
          if (err) {
            console.error("Error fetching objects", err);
            return;
          }
          const nextParts = new Set();
          data.Contents.forEach(item => {
            const parts = item.Key.split("/");
            const nextIndex = getNextIndex(selectedPart);
            if (parts.length > nextIndex) nextParts.add(parts[nextIndex]);
          });
          populateDropdown(document.getElementById(nextPart + 'Select'), Array.from(nextParts));
        });
      }

      function getCurrentPrefix(part) {
        return ['device', 'year', 'month', 'day', 'hour']
          .map(p => document.getElementById(p + 'Select').value)
          .filter(v => v).join('/') + '/';
      }

      function getNextIndex(part) {
        return ['device', 'year', 'month', 'day', 'hour'].indexOf(part) + 1;
      }

      function listImages() {
        const prefix = getCurrentPrefix('hour');
        const params = { Bucket: bucketName, Prefix: prefix };

        s3.listObjectsV2(params, (err, data) => {
          if (err) {
            console.error("Error listing images", err);
            return;
          }
          const imageLinksContainer = document.getElementById('imageLinks');
          imageLinksContainer.innerHTML = '';
          data.Contents.forEach(item => {
            const link = document.createElement('a');
            link.href = `https://${bucketName}.s3.${region}.amazonaws.com/${item.Key}`;
            link.textContent = item.Key.split('/').pop();
            link.target = '_blank';
            link.addEventListener('click', (e) => {
              e.preventDefault();
              document.getElementById('previewImg').src = link.href;
              document.getElementById('imagePreview').style.display = 'block';
            });
            imageLinksContainer.appendChild(link);
            imageLinksContainer.appendChild(document.createElement('br'));
          });
        });
      }
    </script>
  </body>
</html>