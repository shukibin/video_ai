<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Browser for OpenAI Operator</title>

    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- AWS SDK -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.814.0.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
        }
        #sidebar {
            width: 30%;
            background: #f4f4f4;
            padding: 10px;
            overflow-y: auto;
        }
        #content {
            width: 70%;
            padding: 10px;
            text-align: center;
        }
        #image-preview {
            max-width: 100%;
            max-height: 80vh;
            display: none;
        }
        .folder {
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .file {
            margin-left: 20px;
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
        .error-message {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>Image Explorer</h3>
        <div id="folder-structure"></div>
        <div id="error-log" class="error-message"></div>
    </div>
    <div id="content">
        <h3>Image Preview</h3>
        <img id="image-preview" alt="Image Preview" />
    </div>

    <script>
        let s3Client;
        const bucketName = "images-947384912039";
        const region = "us-east-1";
        const identityPoolId = "us-east-1:057eb5c9-a520-4373-80c6-7d43fe3673cb";

        function logError(message, err) {
            console.error(message, err);
            document.getElementById("error-log").innerText = `${message}: ${err.message}`;
        }

        function initializeAwsS3(idToken) {
            try {
                AWS.config.update({
                    region: region,
                    credentials: new AWS.CognitoIdentityCredentials({
                        IdentityPoolId: identityPoolId,
                        Logins: {
                            'accounts.google.com': idToken
                        }
                    })
                });

                AWS.config.credentials.get((err) => {
                    if (err) {
                        logError("AWS Credentials Error", err);
                        return;
                    }
                    console.log("AWS Credentials obtained successfully.");
                    s3Client = new AWS.S3({ apiVersion: '2006-03-01' });
                    loadFolderStructure();
                });
            } catch (err) {
                logError("Error initializing AWS S3", err);
            }
        }

        function loadFolderStructure() {
            try {
                s3Client.listObjectsV2({ Bucket: bucketName }, function (err, data) {
                    if (err) {
                        logError("Error listing S3 objects", err);
                        return;
                    }
                    
                    const folderStructure = {};
                    data.Contents.forEach(obj => {
                        const parts = obj.Key.split('/');
                        let currentLevel = folderStructure;
                        parts.forEach((part, index) => {
                            if (index === parts.length - 1) {
                                currentLevel[part] = obj.Key; // Store full path for files
                            } else {
                                if (!currentLevel[part]) {
                                    currentLevel[part] = {};
                                }
                                currentLevel = currentLevel[part];
                            }
                        });
                    });

                    const container = document.getElementById("folder-structure");
                    if (!container) {
                        logError("Error: Folder structure container is null", new Error("Container missing"));
                        return;
                    }
                    container.innerHTML = "";
                    renderFolderTree(folderStructure, container);
                });
            } catch (err) {
                logError("Unexpected error loading folder structure", err);
            }
        }

        function renderFolderTree(structure, container) {
            try {
                for (let key in structure) {
                    const item = document.createElement("div");
                    if (typeof structure[key] === "object") {
                        item.textContent = key;
                        item.classList.add("folder");
                        const subContainer = document.createElement("div");
                        subContainer.style.display = "none";
                        item.addEventListener("click", () => {
                            subContainer.style.display = subContainer.style.display === "none" ? "block" : "none";
                        });
                        renderFolderTree(structure[key], subContainer);
                        item.appendChild(subContainer);
                    } else {
                        item.textContent = key;
                        item.classList.add("file");
                        item.addEventListener("click", () => previewImage(structure[key]));
                    }
                    container.appendChild(item);
                }
            } catch (err) {
                logError("Error rendering folder tree", err);
            }
        }

        function previewImage(filePath) {
            try {
                const imageUrl = `https://${bucketName}.s3.amazonaws.com/${filePath}`;
                document.getElementById("image-preview").src = imageUrl;
                document.getElementById("image-preview").style.display = "block";
            } catch (err) {
                logError("Error displaying image preview", err);
            }
        }

        // Google Sign-In Initialization
        window.onload = function () {
            google.accounts.id.initialize({
                client_id: "859878185380-o0g59tkq13jm1dhqbt4eb4a4bmgqgjsr.apps.googleusercontent.com",
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("sidebar"),
                { theme: "outline", size: "large" }
            );
        };

        function handleCredentialResponse(response) {
            console.log("Google Sign-In Successful:", response);
            initializeAwsS3(response.credential);
        }
    </script>
</body>
</html>
