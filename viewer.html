<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Browser for OpenAI Operator</title>

    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- AWS SDK -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.814.0.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }
        #image-preview {
            max-width: 100%;
            max-height: 400px;
            margin-top: 1em;
        }
        .dropdown {
            margin: 10px 0;
        }
        button {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Image Browser for OpenAI Operator</h1>
    <p>Authenticate to access the image data and use the dropdowns to select specific images from S3.</p>

    <div id="auth-section">
        <button id="signin-button">Sign in with Google</button>
        <p id="signin-status"></p>
    </div>

    <div id="image-browser" style="display:none;">
        <div>
            <label for="device-dropdown">Device ID:</label>
            <select id="device-dropdown" class="dropdown"></select>
        </div>

        <div>
            <label for="year-dropdown">Year:</label>
            <select id="year-dropdown" class="dropdown"></select>
        </div>

        <div>
            <label for="month-dropdown">Month:</label>
            <select id="month-dropdown" class="dropdown"></select>
        </div>

        <div>
            <label for="day-dropdown">Day:</label>
            <select id="day-dropdown" class="dropdown"></select>
        </div>

        <div>
            <label for="hour-dropdown">Hour:</label>
            <select id="hour-dropdown" class="dropdown"></select>
        </div>

        <div>
            <ul id="image-list"></ul>
        </div>

        <div>
            <img id="image-preview" alt="Image Preview" />
        </div>
    </div>

    <script>
        let s3Client;
        const bucketName = "images-947384912039";
        const region = "us-east-1";
        const identityPoolId = "us-east-1:057eb5c9-a520-4373-80c6-7d43fe3673cb";

        function initializeAwsS3(idToken) {
            AWS.config.update({
                region: region,
                credentials: new AWS.CognitoIdentityCredentials({
                    IdentityPoolId: identityPoolId,
                    Logins: {
                        'accounts.google.com': idToken
                    }
                })
            });

            AWS.config.credentials.get((err) => {
                if (err) {
                    console.error("AWS Credentials Error:", err);
                    alert("Failed to authenticate with AWS: " + err.message);
                } else {
                    console.log("AWS Credentials obtained successfully.");
                    s3Client = new AWS.S3({ apiVersion: '2006-03-01' });
                    loadImageDropdowns();
                }
            });
        }

        function loadImageDropdowns() {
            s3Client.listObjectsV2({ Bucket: bucketName }, function (err, data) {
                if (err) {
                    console.error("Error listing S3 objects:", err);
                    return;
                }

                const objects = data.Contents.map(obj => obj.Key);
                populateDropdowns(objects);
            });
        }

        function populateDropdowns(objects) {
            const deviceSet = new Set();
            const yearSet = new Set();
            const monthSet = new Set();
            const daySet = new Set();
            const hourSet = new Set();

            objects.forEach(key => {
                const parts = key.split('/');
                if (parts.length === 6) {
                    const [device, year, month, day, hour] = parts;
                    deviceSet.add(device);
                    yearSet.add(year);
                    monthSet.add(month);
                    daySet.add(day);
                    hourSet.add(hour);
                }
            });

            populateDropdown('device-dropdown', deviceSet);
            populateDropdown('year-dropdown', yearSet);
            populateDropdown('month-dropdown', monthSet);
            populateDropdown('day-dropdown', daySet);
            populateDropdown('hour-dropdown', hourSet);
        }

        function populateDropdown(id, values) {
            const dropdown = document.getElementById(id);
            dropdown.innerHTML = '<option value="">Select...</option>';
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                dropdown.appendChild(option);
            });
        }

        // Google Sign-In Initialization
        window.onload = function () {
            google.accounts.id.initialize({
                client_id: "859878185380-o0g59tkq13jm1dhqbt4eb4a4bmgqgjsr.apps.googleusercontent.com",
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("signin-button"),
                { theme: "outline", size: "large" }
            );
        };

        function handleCredentialResponse(response) {
            console.log("Google Sign-In Successful:", response);
            document.getElementById('signin-status').textContent = "Signed in successfully.";
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('image-browser').style.display = 'block';

            // Pass the ID token to AWS Cognito authentication
            initializeAwsS3(response.credential);
        }
    </script>
</body>
</html>
